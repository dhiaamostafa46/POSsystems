function JsonParse(e){return"string"==typeof e?JSON.parse(e):e}class NetworkAgent{static version="3.13.22";static getOrderUrl=e=>{let t="https://order.paylink.sa";return"test"===e?t="https://orderpilot.paylink.sa":"stage"===e?t="https://orderstage.paylink.sa":"local"===e?t="http://localhost:8081":"dev"===e&&(t="https://paylinkweb.eu.ngrok.io"),t};static getPublicUrl=e=>{let t="https://paylink.sa";return"test"===e?t="https://pilot.paylink.sa":"stage"===e?t="https://stage.paylink.sa":"local"===e?t="http://localhost:4200":"dev"===e&&(t="https://paylinkng.eu.ngrok.io"),t};static getApiUrl=e=>{let t="https://restapi.paylink.sa";return"test"===e?t="https://restpilot.paylink.sa":"local"===e?t="http://localhost:8085":"stage"===e?t="https://reststage.paylink.sa":"dev"===e&&(t="https://paylinkapi.eu.ngrok.io"),t};static getPaymentUrl=e=>{let t="https://payment.paylink.sa";return"test"===e?t="https://paymentpilot.paylink.sa":"local"===e?t="http://localhost:4200":"stage"===e?t="https://paymentstage.paylink.sa":"dev"===e&&(t="https://paylinkpay.eu.ngrok.io"),t};static callPostAjax(e,t,r,n,a=null){return new Promise((s,i)=>{let l="";"api"===n?l=NetworkAgent.getApiUrl(a)+e:"order"===n&&(l=NetworkAgent.getOrderUrl(a)+e);let o=new XMLHttpRequest;try{o.open("post",l,!0);let d=Object.keys(r);for(let c=0;c<d.length;c++){let p=d[c],y=r[p];o.setRequestHeader(p,y)}o.onreadystatechange=()=>{4===o.readyState&&(o.status<300&&o.status>=200?s(o.responseText):o.responseText.indexOf("{")>-1?this.handleException(i,JsonParse(o.responseText)):this.handleException(i,o.responseText))};let m=JSON.stringify(t);o.send(m)}catch(u){this.handleException(i,u)}})}static addInvoice(e,t){return self.supportedCards&&(e.supportedCardBrands=self.supportedCards),new Promise(async(r,n)=>{try{let a=await NetworkAgent.callPostAjax("/api/addInvoice",e,{Authorization:"Bearer "+t,"Content-Type":"application/json;charset=UTF-8"},"api",self.mode);self.invoiceResponse=a,r(JsonParse(a))}catch(s){n(s)}})}static urPaySendOtp(e,t,r,n){return new Promise(async(a,s)=>{try{let i=await NetworkAgent.callPostAjax("/rest/pay/urpay/sendOtp",{stcpayMobile:t,urpayMobileCountryCode:e,orderNumber:r,total:n},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode),l=JsonParse(i);l.orderNumber=r,l.stcpayMobileCountryCode=e,l.orderNumber=r,l.total=n,a(l)}catch(o){s(o)}})}static stcPayProcessPayment(e,t){return new Promise(async(r,n)=>{let a={stcpayMobile:e.stcpayMobile,stcpayMobileCountryCode:e.stcpayMobileCountryCode,orderNumber:e.orderNumber,total:e.total,stcpayPaymentOTP:t,paymentSessionId:e.paymentSessionId,signature:e.signature,signedBase64Data:e.signedBase64Data};try{let s=await NetworkAgent.callPostAjax("/rest/pay/stcpay/processPayment",a,{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode),i=JsonParse(s);i.transactionNo=i.orderNumber;let l="";l=i.callbackUrl.includes("transactionNo")&&i.callbackUrl.includes("orderNumber")?i.callbackUrl:i.callbackUrl.includes("?")?i.callbackUrl+"&transactionNo="+i.transactionNo+"&orderNumber="+i.externalOrderNumber:i.callbackUrl+"?transactionNo="+i.transactionNo+"&orderNumber="+i.externalOrderNumber,console.log("url",l),window.top.location.href=l,r(i)}catch(o){n(o)}})}static stcPaySendOtp(e,t,r,n){return new Promise(async(a,s)=>{try{let i=await NetworkAgent.callPostAjax("/rest/pay/stcpay/sendOtp",{stcpayMobile:t,stcpayMobileCountryCode:e,orderNumber:r,total:n},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode),l=JsonParse(i);l.orderNumber=r,l.stcpayMobileCountryCode=e,l.orderNumber=r,l.total=n,a(l)}catch(o){s(o)}})}static handleException(e,t){console.log("handling error",t),console.log("rejecting ",e),e("string"==typeof t?{reason:t,success:!1}:t.error?{reason:t.error,success:!1}:t)}static callGetAjax(e,t,r,n=null,a=!0){return new Promise((s,i)=>{let l="";a?"api"===r?l=NetworkAgent.getApiUrl(n)+e:"order"===r&&(l=NetworkAgent.getOrderUrl(n)+e):l=e;let o=new XMLHttpRequest;try{o.onreadystatechange=()=>{4===o.readyState&&(o.status>=200&&o.status<300?s(o.responseText):o.responseText.indexOf("{")>-1?this.handleException(i,JsonParse(o.responseText)):this.handleException(i,o.responseText))},o.open("get",l,!0);let d=Object.keys(t);for(let c=0;c<d.length;c++){let p=d[c],y=t[p];o.setRequestHeader(p,y)}o.send()}catch(m){this.handleException(i,m)}})}}function ApplePayService(){options=options||{},this.mode=options.mode||"production",selfApplePay=this;let e=()=>new Promise((e,t)=>{window.ApplePaySession?window.ApplePaySession.canMakePaymentsWithActiveCard("merchant.sa.paylink.applepay2").then(()=>{e(!0)}):e(!1)});this.proceedToAppleInvoicePayment=async(r,n,a,s,i,l,o,d,c=null)=>(await e(),t(r+" "+n,a,{orderNumber:n,client:s,deliveryCity:i,shippingAddress:l,emailSignature:o},"invoice",d,c)),this.checkAppleInvoicePayment=e=>new Promise(async(t,r)=>{let n=0;console.log("starting function checkAppleInvoicePayment"),console.log("orderNumber",e);let a;for(;n<5;)try{let s=await NetworkAgent.callGetAjax("/web/embeddedJs/"+e,{},"order",self.mode);if(a=JsonParse(s),console.log("received response from web/embeddedJs which is",a),n<5&&!a.orderPaid)await new Promise(e=>setTimeout(e,2e3)),n++;else{let i={orderNumber:e,orderAmount:a.orderTotal,msg:a.orderPaid?"Order "+e+" was processed.":a.lastPaymentError?a.lastPaymentError:"Order "+e+" was declined",webUrl:NetworkAgent.getPaymentUrl(self.mode),callbackUrl:a.callbackUrl,externalOrderNumber:null,statusCode:a.orderPaid?200:400};console.log("return response which is",i),t(i)}}catch(l){console.log("error send web/embeddedJs",l),n<5?(await new Promise(e=>setTimeout(e,2e3)),n++):r(l)}t({orderNumber:e,orderAmount:a.orderTotal,msg:a.orderPaid?"Order "+e+" was processed.":a.lastPaymentError?a.lastPaymentError:"Order "+e+" was declined",webUrl:NetworkAgent.getPaymentUrl(self.mode),callbackUrl:a.callbackUrl,externalOrderNumber:null,statusCode:a.orderPaid?200:400})});let t=(e,t,s,i,l,o)=>{let d=[];return"product"===i&&(d=["name","phone","postalAddress"]),new Promise((i,c)=>{let p={currencyCode:l,countryCode:"SA",requiredShippingContactFields:d,total:{label:e,amount:t},supportedNetworks:["masterCard","visa","mada"],merchantCapabilities:["supports3DS"]},y=n(),m=new ApplePaySession(y,p);m.onvalidatemerchant=e=>{a(e.validationURL,s.orderNumber).then(e=>{m.completeMerchantValidation(e)})},m.onshippingcontactselected=()=>{let r=ApplePaySession.STATUS_SUCCESS;m.completeShippingContactSelection(r,[],{type:"final",label:e,amount:t},[])},m.onpaymentauthorized=e=>{let n=setTimeout(()=>{let e=ApplePaySession.STATUS_SUCCESS;console.log("Timeout for apple, approve and check the apple payment after."),m.completePayment(e);let r={orderNumber:s.orderNumber,orderAmount:t,msg:"ApplePayTimeout",webUrl:null,callbackUrl:null,externalOrderNumber:null,statusCode:""};i(r)},2e4);r(e.payment,s.orderNumber,s.client,t,s.deliveryCity,s.shippingAddress,s.emailSignature).then(e=>{let t;e?(t=ApplePaySession.STATUS_SUCCESS,m.completePayment(t),clearInterval(n),i(e)):(t=ApplePaySession.STATUS_FAILURE,m.completePayment(t),clearInterval(n),i(e))}).catch(e=>{let t=ApplePaySession.STATUS_FAILURE;m.completePayment(t),clearInterval(n),c(e)})},m.oncancel=()=>{null!=o&&o()},m.begin()})},r=(e,t,r,n,a,s,i)=>new Promise(async(l,o)=>{let d={paymentPacket:{orderNumber:t,clientName:r.name,clientMobile:r.mobile,clientCountryCode:r.countryCode,shipmentCity:a,shipmentAddress:s,emailSignature:i},paymentToken:e.token,total:n};try{let c=await NetworkAgent.callPostAjax("/rest/pay/apple/processPayment",d,{"Content-Type":"application/json;charset=UTF-8"},"order",selfApplePay.mode);l(c)}catch(p){o(p)}}),n=()=>{if(window.ApplePaySession.supportsVersion(6))return 6;if(window.ApplePaySession.supportsVersion(5))return 5;if(window.ApplePaySession.supportsVersion(4))return 4;if(window.ApplePaySession.supportsVersion(3))return 3;if(window.ApplePaySession.supportsVersion(2))return 2;else return 1},a=(e,t)=>new Promise(async(r,n)=>{try{let a=await NetworkAgent.callPostAjax("/rest/pay/apple/validateMerchant/"+t,{validationUrl:e},{"Content-Type":"application/json;charset=UTF-8"},"order",selfApplePay.mode);r(a)}catch(s){n(s)}})}function requiredArg(e){throw Error("The argument "+e+" is required")}function requiredValidType(e,t){throw Error("The argument "+e+" must be of type "+t)}const ProductConfig={title:{type:String},price:{type:Number},qty:{type:Number},isDigital:{type:Boolean},description:{type:String}};function Product(e={}){this.title=e.title||requiredArg("title"),this.price=e.price||requiredArg("price"),this.qty=e.qty||requiredArg("qty"),this.isDigital=e.isDigital||!1,this.description=e.description||null}let EmailValidationResponseConfig={signature:"",emailType:"",success:!1},OrderResponseModel={amount:0,transactionNo:"",orderStatus:"",url:"",success:!1,digitalOrder:!1},OrderModel={callBackUrl:"",clientEmail:"",clientName:"",clientMobile:"",amount:0,orderNumber:"",supportedCardBrands:[""],products:[Product]},StcPayOtpResponseModel={orderNumber:"",stcMobile:"",stcpayMobileCountryCode:"",stcpayMobile:"",paymentSessionId:"",signature:"",signedBase64Data:"",total:0},PaymentSessionResponseModel={device:{browser:"",ipAddress:""},merchant:"",session:{id:"",updateStatus:"",version:""},sourceOfFunds:{provided:{card:{brand:"",expiry:{month:"",year:""},fundingMethod:"",nameOnCard:"",number:"",scheme:"",securityCode:""}},type:""},status:"",version:""},StcPayPaymentResponseModel={transactionNo:"",orderAmount:0,orderNumber:"",msg:"",callbackUrl:"",externalOrderNumber:""};function Order(e={}){this.callBackUrl=e.callBackUrl||requiredArg("callBackUrl"),this.clientEmail=e.clientEmail||requiredArg("clientEmail"),this.clientName=e.clientName||requiredArg("clientName"),this.clientMobile=e.clientMobile||requiredArg("clientMobile"),this.amount=e.amount||requiredArg("amount"),this.orderNumber=e.orderNumber||requiredArg("orderNumber"),this.products=e.products||[];for(let t=0;t<this.products;t++)!this.products[t] instanceof Product&&requiredValidType("products","Product")}const CardBrand={ANY:"ANY",MADA:"MADA",VISA:"VISA",MASTERCARD:"MASTERCARD"},PaylinkPaymentsConfig={mode:"",backgroundColor:"",defaultLang:"en",supportedCards:[CardBrand.ANY]};function PaylinkPayments(e={}){e=e||{},this.mode=e.mode||"production",this.defaultLang=e.defaultLang||"en",this.backgroundColor=e.backgroundColor||"#EEE",this.order=null,this.paylinkTransactionId=null,this.transactionId=null,this.signature=null,this.paymentResponseFn=null,null!==e.supportedCards&&Array.isArray(e.supportedCards)?this.supportedCards=e.supportedCards:this.supportedCards=[CardBrand.ANY],self=this,Object.keys||(Object.keys=function(e){let t=[];for(let r in e)e.hasOwnProperty(r)&&t.push(r);return t});let t=()=>new Promise((e,t)=>{void 0===window.NetworkAgent?setTimeout(()=>{e(!0)},1e3):e(!0)}),r=function(){let e=document.createElement("div");return e.id="divBlackOut",e.style.position="absolute",e.style.zIndex="1010",e.style.left="0",e.style.top="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0,0,0,.65)",e.style.display="none",e},n=function(){document.getElementById("divBlackOut").style.display="block"},a=function(){let e=document.getElementById("divBlackOut");e.style.display="none",e.remove()},s=function(){let e=document.createElement("div");return e.id="paylinkProgressIndicator",e.style.height="150px",e.style.width="150px",e.style.left="50%",e.style.top="50%",e.style.transform="translate(-50%,-50%)",e.style.position="absolute",e.style.padding="0",e.style.opacity="0",e.style.pointerEvents="none",e.style.transition="all 300ms easy-in-out",e.style.zIndex="1011",e.innerHTML="<img style='background-color: transparent' src='"+NetworkAgent.getPaymentUrl(self.mode)+"/assets/img/Eclipse-1s-200px.svg' alt='Loading...' />",e},i=function(e=365,t=450){let r=document.createElement("div");r.id="paylinkDivModal",r.style.height=window.innerWidth>576?e+"px":t+"px",r.style.width=window.innerWidth>576?"550px":"100%",r.style.backgroundColor=self.backgroundColor,r.style.position="absolute",r.style.left="50%",r.style.top="50%",r.style.borderRadius="0.45rem",r.style.transform="translate(-50%,-50%)",r.style.padding="0",r.style.opacity="0",r.style.pointerEvents="none",r.style.transition="all 300ms easy-in-out",r.style.zIndex="1011";let n=y();return r.appendChild(n),r},l=function(e){let t=document.createElement("div");return t.className="bootstrap-paylink w-100 py-3 text-dark-50 d-flex flex-column d-none",t.innerHTML=e,t},o=function(){let e=document.getElementById("paylinkDivModal");e.style.opacity="1",e.style.pointerEvents="auto"},d=function(){let e=document.getElementById("paylinkProgressIndicator");e.style.opacity="1",e.style.pointerEvents="auto"},c=function(){let e=document.getElementById("paylinkProgressIndicator");e.style.opacity="0",e.style.pointerEvents="none",e.remove()},p=function(){let e=document.getElementById("paylinkDivModal");e.style.opacity="0",e.style.pointerEvents="none",e.remove()},y=function(){let e=document.createElement("span");return e.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-x-circle"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',e.style.padding="5px",e.style.color="#000",e.style.fontFamily="Arial",e.style.fontSize="1.2rem",e.style.position="absolute",e.style.right="5px",e.style.top="5px",e.style.cursor="pointer",e.onclick=()=>{p(),a()},e},m=function(){let e=document.createElement("link");return e.setAttribute("href",NetworkAgent.getPaymentUrl(self.mode)+"/assets/css/bootstrap-paylink.css"),e.setAttribute("rel","stylesheet"),e},u=function(e,t=365,n=450){let a=document.getElementsByTagName("body")[0],o=r(),d=i(t,n),c=s();a.appendChild(o),a.appendChild(d),a.appendChild(c);let p=l(e);d.appendChild(p);let y=m();document.head.appendChild(y)},g=function(){_(x);let e=document.getElementById("email"),t=document.getElementById("otp");e.removeAttribute("readonly"),t.style.display="none";let r=document.getElementById("confirmEmailMsg"),n=document.getElementById("submitEmailMsg");r.style.display="none",n.style.display="inline"},h=function(e){T(v),console.log("email validation response config",e);let t=document.getElementById("confirmEmailMsg"),r=document.getElementById("submitEmailMsg");t.style.display="inline",r.style.display="none";let n=document.getElementById("email"),a=document.getElementById("otp"),s=document.getElementById("signature");s.value=e.signature,console.log("signature of confirm received",s);document.getElementById("transactionId").value=e,n.setAttribute("readonly","readonly"),a.style.display="block"},f=async e=>await k(("string"==typeof e?JsonParse(e):e).transactionNo),b=async(e,t)=>{self.payMode="card",console.log("self pay mode",self.payMode);let r=JsonParse(e);self.paylinkTransactionId=r.transactionNo;let a=!0;null!=r.url&&r.url.indexOf("https://")>-1&&(a=!1);let s=await NetworkAgent.callGetAjax(r.url+"?lang="+self.defaultLang+"&bgColor="+self.backgroundColor,{Accept:"text/html"},"order",self.mode,a);if(s.includes("emailConfirmDiv"))p(),u(s,350,450),g(),n(),o(),c();else{p(),u(s);let i=await NetworkAgent.callGetAjax("/rest/pay/settings",{},"order",self.mode);setTimeout(()=>{n(),o(),c(),B(S),t&&setTimeout(async()=>{let e=await N(i);console.log("mpgs response",e),t("ok")},500)},150)}};this.openPayment=(e,t,r)=>{self.order=t,u(""),n(),d(),NetworkAgent.callPostAjax("/api/createInvoice",t,{Authorization:"Bearer "+e,"Content-Type":"application/json;charset=UTF-8"},"api",self.mode).then(e=>{b(e,r)}).catch(e=>{throw e})},this.sendPayment=async(e,t)=>{self.order=t;try{let r=await NetworkAgent.addInvoice(t,e);return console.log("invoice response from addInvoice is: ",r),f(r)}catch(n){throw console.log("throwing error: ",n),n}},this.sendInvoice=async(e,t)=>(self.order={},self.order.clientName=t,self.order.clientEmail=t,self.order.clientMobile=t,k(t)),this.submitInvoice=async(e,t,r=[CardBrand.ANY])=>(self.order={},self.order.clientName=e,self.order.clientEmail=e,self.order.clientMobile=e,self.paymentResponseFn=t,self.supportedCards=r,k(e));let k=e=>new Promise((t,r)=>{self.payMode="card",self.paylinkTransactionId=e,self.embedJs=!0,NetworkAgent.callGetAjax("/web/embeddedJs/"+e,{},"order",self.mode).then(e=>{console.log("response from embedded js",e);let t=JsonParse(e);t.requireDigitalConfirm?r({success:!1,reason:"digital order require confirm by email"}):t.orderPaid?t.callbackUrl?r({success:!1,reason:"order already paid",callbackUrl:t.callbackUrl}):r({success:!1,reason:"order already paid"}):(self.transactionId=t.transactionId,self.signature=t.signature,PaymentSession.updateSessionFromForm("card"))}).catch(e=>{console.log("error",e),r(e)})});this.setupCardFieldSizes=(e,t,r,n,a,s,i,l=!0)=>{self.widthOffset=s,self.heightOffset=i;let o=!0;return self.nameOnCardWidth="string"==typeof t&&t.indexOf("#")>-1?document.getElementById(t.replace("#","")).clientWidth:t.width?t.width:t,self.nameOnCardHeight="string"==typeof t&&t.indexOf("#")>-1?document.getElementById(t.replace("#","")).clientHeight:t.height?t.height:t,(0===self.nameOnCardWidth||0===self.nameOnCardHeight)&&(l&&console.error("Name On Card input is hidden. This could effect the look of the payment form."),o=!1),self.cardNumberWidth="string"==typeof e&&e.indexOf("#")>-1?document.getElementById(e.replace("#","")).clientWidth:e.width?e.width:e,self.cardNumberHeight="string"==typeof e&&e.indexOf("#")>-1?document.getElementById(e.replace("#","")).clientHeight:e.height?e.height:e,(0===self.cardNumberWidth||0===self.cardNumberHeight)&&(l&&console.error("Card number input is hidden. This could effect the look of the payment form."),o=!1),self.expYearWidth="string"==typeof r&&r.indexOf("#")>-1?document.getElementById(r.replace("#","")).clientWidth:r.width?r.width:r,self.expYearHeight="string"==typeof r&&r.indexOf("#")>-1?document.getElementById(r.replace("#","")).clientHeight:r.height?r.height:r,(0===self.expYearWidth||0===self.expYearHeight)&&(l&&console.error("Expiry Year input is hidden. This could effect the look of the payment form."),o=!1),self.expMonthWidth="string"==typeof n&&n.indexOf("#")>-1?document.getElementById(n.replace("#","")).clientWidth:n.width?n.width:n,self.expMonthHeight="string"==typeof n&&n.indexOf("#")>-1?document.getElementById(n.replace("#","")).clientHeight:n.height?n.height:n,(0===self.expMonthWidth||0===self.expMonthHeight)&&(l&&console.error("Expiry Month input is hidden. This could effect the look of the payment form."),o=!1),self.cardCvvWidth="string"==typeof a&&a.indexOf("#")>-1?document.getElementById(a.replace("#","")).clientWidth:a.width?a.width:a,self.cardCvvHeight="string"==typeof a&&a.indexOf("#")>-1?document.getElementById(a.replace("#","")).clientHeight:a.height?a.height:a,(0===self.cardCvvWidth||0===self.cardCvvHeight)&&(l&&console.error("Card CVV input is hidden. This could effect the look of the payment form."),o=!1),o};let w=(e,t,r)=>{if(0!==t)e.style.width=t+self.widthOffset+"px";else{let n=parseInt(window.getComputedStyle(e).getPropertyValue("width"),10);"cnum"===name?this.cardNumberWidth=n:"cname"===name?this.nameOnCardWidth=n:"expY"===name?this.expYearWidth=n:"expM"===name?this.expMonthWidth=n:"cvv"===name&&(this.cardCvvWidth=n)}if(0!==r)e.style.height=r+self.heightOffset+"px";else{let a=parseInt(window.getComputedStyle(e).getPropertyValue("height"),10);"cnum"===name?this.cardNumberHeight=a:"cname"===name?this.nameOnCardHeight=a:"expY"===name?this.expYearHeight=a:"expM"===name?this.expMonthHeight=a:"cvv"===name&&(this.cardCvvHeight=a)}},$=()=>{let e=document.getElementsByClassName("gw-proxy-number")[0],t=document.getElementsByClassName("gw-proxy-nameOnCard")[0],r=document.getElementsByClassName("gw-proxy-expiryYear")[0],n=document.getElementsByClassName("gw-proxy-expiryMonth")[0],a=document.getElementsByClassName("gw-proxy-securityCode")[0];setInterval(()=>{w(e,self.cardNumberWidth,self.cardNumberHeight),w(t,self.nameOnCardWidth,self.nameOnCardHeight),w(r,self.expYearWidth,self.expYearHeight),w(n,self.expMonthWidth,self.expMonthHeight),w(a,self.cardCvvWidth,self.cardCvvHeight)},500)};this.restartPaymentForm=(e,t,r,n,a)=>{let s=document.getElementsByClassName("gw-proxy-nameOnCard");for(;s.length>0;)s[0].remove();document.getElementById(t.replace("#","")).style.display="block";let i=document.getElementsByClassName("gw-proxy-number");for(;i.length>0;)i[0].remove();document.getElementById(e.replace("#","")).style.display="block";let l=document.getElementsByClassName("gw-proxy-expiryYear");for(;l.length>0;)l[0].remove();document.getElementById(r.replace("#","")).style.display="block";let o=document.getElementsByClassName("gw-proxy-expiryMonth");for(;o.length>0;)o[0].remove();document.getElementById(n.replace("#","")).style.display="block";let d=document.getElementsByClassName("gw-proxy-securityCode");for(;d.length>0;)d[0].remove();document.getElementById(a.replace("#","")).style.display="block",this.initPayment(e,t,r,n,a,self.paymentErrorFn,self.widthOffset,self.heightOffset)};let A=e=>{let t=document.getElementById(e.replace("#",""));console.log("before: element style",t.getAttribute("style")),console.log("before: element style width",t.style.width),t.style.width="100%",console.log("after: element style",t.getAttribute("style")),console.log("after: element style width",t.style.width)};this.initPayment=(e,r,n,a,s,i,l=8,o=3)=>(self.paymentErrorFn=i,A(e),A(r),A(n),A(a),A(s),new Promise(async(d,c)=>{await t();try{let p=await NetworkAgent.callGetAjax("/rest/pay/settings",{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode);i||(i=()=>{});let y=await N(p,i,e,s,a,n,r,l,o);setTimeout(()=>{d({success:!0,response:y})},150)}catch(m){c(m)}})),this.sendApplePayInvoice=async(e,t)=>(self.order={},self.order.clientName=t,self.order.clientEmail=t,self.order.clientMobile=t,C(t)),this.submitApplePayInvoice=async e=>(self.order={},self.order.clientName=e,self.order.clientEmail=e,self.order.clientMobile=e,C(e)),this.sendApplePay=(e,r)=>new Promise(async(n,a)=>{if(self.order=r,this.isApplePayAllowed()){await t();let s=await NetworkAgent.callPostAjax("/api/addInvoice",r,{Authorization:"Bearer "+e,"Content-Type":"application/json;charset=UTF-8"},"api",self.mode);self.invoiceResponse=s;let i=JsonParse(s);self.paylinkTransactionId=i.transactionNo;let l=await C(i.transactionNo);n(l)}else a("This browser does not support ApplePay. Please use Safari on any Apple Device.")}),this.sendStcPayOtp=async(e,r,n)=>{await t(),self.paylinkTransactionId=e;try{return await NetworkAgent.stcPaySendOtp(r,n,e,null)}catch(a){throw a}},this.sendStcPayOtp=async(e,r,n,a)=>{self.order=r,await t();let s=await NetworkAgent.addInvoice(r,e);self.paylinkTransactionId=s.transactionNo;try{return await NetworkAgent.stcPaySendOtp(n,a,s.transactionNo,s.amount)}catch(i){throw i}},this.processStcPayPayment=async(e,r)=>{await t();try{return await NetworkAgent.stcPayProcessPayment(r,e)}catch(n){throw n}},this.openApplePay=(e,r)=>{self.order=r,this.isApplePayAllowed()?(u(""),n(),d(),t().then(()=>{NetworkAgent.callPostAjax("/api/createInvoice",r,{Authorization:"Bearer "+e,"Content-Type":"application/json;charset=UTF-8"},"api",self.mode).then(e=>{self.invoiceResponse=e;let t=JsonParse(e);self.paylinkTransactionId=t.transactionNo,E(t)})})):alert("This browser does not support ApplePay. Please use Safari on any Apple Device.")};let C=e=>new Promise(async(r,n)=>{self.payMode="applePay",self.paylinkTransactionId=e,await t();try{let a=await NetworkAgent.callGetAjax("/web/embeddedJs/"+e,{},"order",self.mode),s=JsonParse(a);if(s.requireDigitalConfirm)n({success:!1,reason:"digital order require confirm by email"});else if(s.orderPaid)n(s.callbackUrl?{success:!1,reason:"order already paid",callbackUrl:json.callbackUrl}:{success:!1,reason:"order already paid"});else if(s.sameDomainApplePay){let i=new ApplePayService({mode:self.mode}),l=await i.proceedToAppleInvoicePayment("#"+e,transactionId,s.orderTotal,{mobile:s.clientMobile,name:s.clientName},null,null,null,null);"ApplePayTimeout"===l.msg&&(console.log("response of AppleTimeOut is:",l),l=await i.checkAppleInvoicePayment(s.orderNumber)),l.callbackUrl?window.location.href=l.callbackUrl:r({success:!0})}else self.emailSignature?window.location=NetworkAgent.getPublicUrl(self.mode)+"/pay/applePay/"+self.paylinkTransactionId+"?signature="+btoa(self.emailSignature):window.location=NetworkAgent.getPublicUrl(self.mode)+"/pay/applePay/"+self.paylinkTransactionId}catch(o){n(o)}}),E=function(e=null){self.payMode="applePay",t().then(()=>{null!=e&&e.digitalOrder?NetworkAgent.callGetAjax(e.url+"?lang="+self.defaultLang+"&bgColor="+self.backgroundColor,{},"order",self.mode).then(e=>{p(),u(e,350,450),g(),n(),o(),c()}):self.emailSignature?window.location=NetworkAgent.getPublicUrl(self.mode)+"/pay/applePay/"+self.paylinkTransactionId+"?signature="+btoa(self.emailSignature):window.location=NetworkAgent.getPublicUrl(self.mode)+"/pay/applePay/"+self.paylinkTransactionId})};this.isApplePayAllowed=function(){return!!window.ApplePaySession};let v=function(){I();let e=document.getElementById("email"),r=document.getElementById("otp"),a=document.getElementById("signature");console.log("signature of confirm submitted",a),(null===r.value||""===r.value)&&alert("OTP is required"),(null===e.value||""===e.value)&&alert("E-Mail is required");let s="/rest/pay/confirmClientEmail/"+self.paylinkTransactionId;t().then(()=>{NetworkAgent.callPostAjax(s,{email:e.value,emailType:"EmailOtp",otp:r.value,signature:a.value},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode).then(e=>{p(),u(""),n(),d(),self.emailSignature=JsonParse(e).signature,"card"===self.payMode?b(self.invoiceResponse):"applePay"===self.payMode&&E(self.invoiceResponse)}).catch(e=>{console.log("error",e),g()})})},x=function(){I();let e=document.getElementById("email"),r="/rest/pay/registerClientEmail/"+self.paylinkTransactionId;t().then(()=>{NetworkAgent.callPostAjax(r,{email:e.value,emailType:"EmailOtp"},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode).then(e=>{h(JsonParse(e))}).catch(e=>{console.log("error",e),g()})})},P=(e,t,r,n,a,s,i)=>{PaymentSession.setFocusStyle(["card.number","card.securityCode","card.expiryMonth","card.expiryYear","card.nameOnCard"],{maxWidth:"1000px",width:"100%"}),PaymentSession.setHoverStyle(["card.number","card.securityCode","card.expiryMonth","card.expiryYear","card.nameOnCard"],{maxWidth:"1000px",width:"100%"}),PaymentSession.configure({fields:{card:{number:t,securityCode:r,expiryMonth:n,expiryYear:a,nameOnCard:s}},frameEmbeddingMitigation:["csp"],callbacks:{initialized(e){for(let t=0;t<1e4;t++)window.clearInterval(t);$(),i(e)},formSessionUpdate(t){e?O(t,e):U(t)}},interaction:{displayControl:{formatCard:"EMBOSSED",invalidFieldCharacters:"REJECT"}}})},N=(e,t,r="#card-number",n="#security-code",a="#expiry-month",s="#expiry-year",i="#cardholder-name",l=8,o=3)=>new Promise((d,c)=>{let p=JsonParse(e),y=document.createElement("script");y.setAttribute("src",p.sessionFormUrl),document.body.appendChild(y);let m=setInterval(()=>{if(!PaymentSession)return;clearInterval(m);let e=setInterval(()=>{this.setupCardFieldSizes(r,i,s,a,n,l,o,!1)&&(clearInterval(e),P(t,r,n,a,s,i,d))},1e3)},1e3)}),I=function(){let e=document.getElementById("paylink-payBtn"),t=document.getElementById("paylink-confirmEmail"),r=document.getElementById("paylink-submitEmail"),n=document.getElementById("paylink-loadingBtn");e&&(e.style.display="none",e.onclick=null),t&&(t.style.display="none",t.onclick=null),r&&(r.style.display="none",r.onclick=null),n&&(n.style.display="block")},_=function(e){let t=document.getElementById("paylink-payBtn"),r=document.getElementById("paylink-confirmEmail"),n=document.getElementById("paylink-submitEmail"),a=document.getElementById("paylink-loadingBtn");t&&(t.style.display="none"),n&&(n.style.display="block",n.onclick=e),r&&(r.style.display="none"),a&&(a.style.display="none")},T=function(e){let t=document.getElementById("paylink-payBtn"),r=document.getElementById("paylink-confirmEmail"),n=document.getElementById("paylink-submitEmail"),a=document.getElementById("paylink-loadingBtn");t&&(t.style.display="none"),n&&(n.style.display="none"),r&&(r.style.display="block",r.onclick=e),a&&(a.style.display="none")},B=function(e){let t=document.getElementById("paylink-payBtn"),r=document.getElementById("paylink-confirmEmail"),n=document.getElementById("paylink-submitEmail"),a=document.getElementById("paylink-loadingBtn");t&&(t.style.display="block",t.onclick=e),n&&(n.style.display="none"),r&&(r.style.display="none"),a&&(a.style.display="none")},S=()=>{I(),PaymentSession.updateSessionFromForm("card")},M=e=>{if(-1===self.supportedCards.indexOf(CardBrand.ANY)){let t=e.sourceOfFunds.provided.card.brand;if(-1===self.supportedCards.indexOf(t))return!1}return!0},O=(e,r)=>{if(e.status){if("ok"===e.status){if(!M(e)){r({success:!1,reason:"Card Type not allowed"});return}console.log("transactionId",self.transactionId),console.log("signature",self.signature),t().then(()=>{NetworkAgent.callPostAjax("/rest/pay/openGateway",{sessionId:e.session.id,orderNumber:self.paylinkTransactionId,clientName:self.order.clientName,clientEmail:self.order.clientEmail,clientMobile:self.order.clientMobile,mode:"frame",shipmentCity:"",transactionId:self.transactionId,shipmentAddress:"",signature:self.signature,emailSignature:self.emailSignature},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode).then(e=>{let t=JsonParse(e);if(null!=t.secure3DHtmlKey){let n=t.secure3DHtmlKey;setTimeout(()=>{window.top.location.href=NetworkAgent.getOrderUrl(self.mode)+"/rest/pay/get3DPage?key="+n+"&signature="+self.signature},500)}else null!=t.error&&r({success:!1,reason:t.error})}).catch(e=>{try{console.log("error response when open gateway",e),r({success:!1,reason:e.error.error})}catch(t){r({success:!1,reason:t})}})}).catch(e=>{r({success:!1,reason:e})})}else"fields_in_error"===e.status?e.errors.cardNumber?(r({success:!1,reason:"Card number invalid or missing."}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:"Card number invalid or missing."})):e.errors.expiryYear?(r({success:!1,reason:"Expiry year invalid or missing."}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:"Expiry year invalid or missing."})):e.errors.expiryMonth?(r({success:!1,reason:"Expiry month is invalid or missing."}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:"Expiry month is invalid or missing."})):e.errors.securityCode&&(r({success:!1,reason:"Security code invalid."}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:"Security code invalid."})):"request_timeout"===e.status?(r({success:!1,reason:e.errors.message}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:e.errors.message})):"system_error"===e.status&&(r({success:!1,reason:e.errors.message}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:e.errors.message}))}else r({success:!1,reason:"Session update failed: "+e}),self.paymentResponseFn&&self.paymentResponseFn({success:!1,reason:"Session update failed: "+e})},U=e=>{if(e.status){if("ok"===e.status){let r=document.getElementById("transactionId"),n=document.getElementById("signature");t().then(()=>{if(!M(e)){F("Card Type not allowed");return}NetworkAgent.callPostAjax("/rest/pay/openGateway",{sessionId:e.session.id,orderNumber:self.paylinkTransactionId,clientName:self.order.clientName,clientEmail:self.order.clientEmail,clientMobile:self.order.clientMobile,mode:"frame",shipmentCity:"",transactionId:r.value,shipmentAddress:"",signature:n.value,emailSignature:self.emailSignature},{"Content-Type":"application/json;charset=UTF-8"},"order",self.mode).then(e=>{let t=JsonParse(e);if(null!=t.secure3DHtmlKey){B(S);let r=t.secure3DHtmlKey;setTimeout(()=>{window.top.location.href=NetworkAgent.getOrderUrl(self.mode)+"/rest/pay/get3DPage?key="+r+"&signature="+n.value},500)}else null!=t.error&&(B(S),F(t.error))}).catch(e=>{try{console.log("error response when open gateway",e),F(e.error.error),B(S)}catch(t){F("Error processing card.\r\n Ø®Ø·Ø§ ÙÙŠ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹"),B(S)}})})}else"fields_in_error"===e.status?(e.errors.cardNumber&&(self.defaultLang,F("Card number invalid or missing."),B(S)),e.errors.expiryYear&&(F("Expiry year invalid or missing."),B(S)),e.errors.expiryMonth&&(F("Expiry month is invalid or missing."),B(S)),e.errors.securityCode&&(F("Security code invalid."),B(S))):"request_timeout"===e.status?(F(e.errors.message),B(S)):"system_error"===e.status&&(F(e.errors.message),B(S))}else F("Session update failed: "+e),B(S)},F=e=>{if("ar"===self.defaultLang)switch(e){case"Card number invalid or missing.":e="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ØºÙŠØ± ØµØ­ÙŠØ­";break;case"Card does not support 3D Secure":e="Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ù„Ø§ØªØ¯Ø¹Ù… Ø§Ù„Ø­Ù…Ø§ÙŠØ© Ø§Ù„Ø«Ù„Ø§Ø«ÙŠØ©.";break;case"Expiry year invalid or missing.":e="ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø³Ù†Ø© ØºÙŠØ± ØµØ­ÙŠØ­";break;case"Expiry month is invalid or missing.":e="ØªØ§Ø±ÙŠØ® Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø´Ù‡Ø± ØºÙŠØ± ØµØ­ÙŠØ­";break;case"Security code invalid.":e="Ø±Ù…Ø² Ø§Ù„Ø­Ù…Ø§ÙŠØ© ØºÙŠØ± ØµØ­ÙŠØ­"}let t=document.getElementById("serverMsg");t.style.display="block",t.innerHTML=e}}let eventMethod=window.addEventListener?"addEventListener":"attachEvent",eventer=window[eventMethod],messageEvent="attachEvent"===eventMethod?"onmessage":"message";eventer(messageEvent,function(e){let t=e[e.message?"message":"data"];console.log(t)},!1);